---
last_mapped: 2026-01-27T17:35:00Z
total_files: 20
total_tokens: 19307
---

# Codebase Map: Documentation Automation Hub

> Auto-generated by Cartographer. Last mapped: 2026-01-27

## System Overview

The **Documentation Automation Hub** is a centralized webhook service that automates documentation generation for multiple projects using Claude Code CLI and the Cartographer skill. It receives webhooks from GitHub Actions, orchestrates documentation generation through various strategies, creates pull requests with the generated documentation, and handles post-merge service restarts.

**Stack**: Node.js (Express), Bash scripts, Claude AI API, GitHub API, PM2, Nginx
**Architecture**: Event-driven microservice with job queuing
**Deployment**: PM2 process manager on AWS EC2, exposed via nginx reverse proxy

```mermaid
graph TB
    subgraph GitHub
        Actions[GitHub Actions]
        PR[Pull Requests]
    end

    subgraph Nginx
        Proxy[Reverse Proxy<br/>y1.andiami.tech/doc-hub/]
    end

    subgraph "Hub Server (PM2)"
        Server[server.js<br/>Express Webhook Listener]
        Queue[Job Queue<br/>Max 2 concurrent]
    end

    subgraph Handlers
        GenDocs[generate-docs.sh]
        CreatePR[create-pr.sh]
        Restart[restart-service.sh]
    end

    subgraph "Cartographer Integration"
        Programmatic[invoke-cartographer-<br/>programmatic.mjs]
        Scanner[Python Scanner]
        ClaudeAPI[Claude API]
    end

    subgraph Projects
        Wish[wish-x]
        Backend[wish-backend-x]
        MultiAgent[as-you-wish-multi-agent]
        Agent[claude-agent-server]
    end

    Actions -->|POST /webhook/generate-docs| Proxy
    Proxy -->|localhost:6000| Server
    Server --> Queue
    Queue --> GenDocs
    GenDocs --> Programmatic
    Programmatic --> Scanner
    Programmatic --> ClaudeAPI
    ClaudeAPI -->|docs/CODEBASE_MAP.md| GenDocs
    GenDocs --> CreatePR
    CreatePR --> PR
    PR -->|Merge| Actions
    Actions -->|POST /webhook/restart-service| Server
    Server --> Restart
    Restart --> Projects

    style Server fill:#4A90E2
    style Queue fill:#7B68EE
    style Programmatic fill:#50C878
    style ClaudeAPI fill:#FFD700
```

## Directory Structure

```
doc-automation-hub/
â”œâ”€â”€ ğŸ“„ server.js                        # Express webhook listener (397 lines, 2557 tokens)
â”œâ”€â”€ ğŸ“„ ecosystem.config.js              # PM2 process configuration
â”œâ”€â”€ ğŸ“„ package.json                     # Node.js dependencies
â”œâ”€â”€ ğŸ“„ project-registry.json            # Multi-project configuration database
â”œâ”€â”€ ğŸ“„ .env.example                     # Environment variable template
â”œâ”€â”€ ğŸ“„ .gitignore                       # Git ignore patterns
â”‚
â”œâ”€â”€ ğŸ“ handlers/                        # Bash orchestration scripts
â”‚   â”œâ”€â”€ generate-docs.sh               # Main doc generation workflow (141 lines)
â”‚   â”œâ”€â”€ create-pr.sh                   # GitHub PR creation (112 lines)
â”‚   â””â”€â”€ restart-service.sh             # Post-merge service restart (146 lines)
â”‚
â”œâ”€â”€ ğŸ“ utils/                           # Cartographer invocation strategies
â”‚   â”œâ”€â”€ invoke-cartographer-programmatic.mjs  # âœ… Primary: Direct API (300 lines)
â”‚   â”œâ”€â”€ invoke-cartographer.mjs        # âŒ Deprecated: SDK-based (152 lines)
â”‚   â”œâ”€â”€ invoke-cartographer-direct.sh  # âš ï¸  Simple: CLI passthrough (74 lines)
â”‚   â””â”€â”€ invoke-cartographer-v2.sh      # ğŸ§ª Experimental: Print mode (68 lines)
â”‚
â”œâ”€â”€ ğŸ“ logs/                            # Application logs
â”‚   â”œâ”€â”€ hub-YYYY-MM-DD.log             # Daily JSON logs
â”‚   â”œâ”€â”€ error.log                      # PM2 stderr
â”‚   â””â”€â”€ out.log                        # PM2 stdout
â”‚
â”œâ”€â”€ ğŸ“ docs/                            # Generated documentation
â”‚   â””â”€â”€ CODEBASE_MAP.md                # This file
â”‚
â”œâ”€â”€ ğŸ“„ test-cartographer-*.mjs         # Invocation experiments (4 files)
â”œâ”€â”€ ğŸ“„ README.md                        # Comprehensive user docs (354 lines)
â”œâ”€â”€ ğŸ“„ SETUP-COMPLETE.md                # Setup checklist (406 lines)
â””â”€â”€ ğŸ“„ NGINX-CONFIG.md                  # Reverse proxy docs (252 lines)
```

## Module Guide

### Core Server Module

#### server.js

**Purpose**: Express.js webhook listener that receives GitHub webhooks, validates signatures, manages job queue, and orchestrates documentation generation

**Key Exports**: Express app instance (HTTP server)

**Endpoints**:
| Endpoint | Method | Purpose | Auth |
|----------|--------|---------|------|
| `/health` | GET | Health check and status | None |
| `/webhook/generate-docs` | POST | Trigger doc generation | HMAC |
| `/webhook/restart-service` | POST | Restart service after merge | HMAC |

**Key Functions**:
- `verifyWebhookSignature(req)` - HMAC-SHA256 signature validation
- `loadProjectRegistry()` - Load project configurations from JSON
- `log(level, message, meta)` - Structured JSON logging to daily files
- `processJob(job)` - Execute documentation generation for one project
- `processQueue()` - Manage concurrent job execution (max 2 simultaneous)

**Configuration** (Environment Variables):
```bash
PORT=6000                        # Webhook listener port
WEBHOOK_SECRET=<hmac-secret>     # Signature validation
GITHUB_TOKEN=ghp_xxx             # GitHub API token
MAX_CONCURRENT_JOBS=2            # Parallel job limit
JOB_TIMEOUT_MINUTES=30           # Max execution time per job
```

**Data Flow**:
1. Receive webhook â†’ Verify signature â†’ Extract project name
2. Look up project in registry â†’ Check if enabled
3. Add job to queue â†’ Return 202 Accepted
4. When queue slot available â†’ Execute `handlers/generate-docs.sh`
5. Log results â†’ Process next job in queue

**Dependencies**:
- `express` - Web server framework
- `crypto` - HMAC signature verification
- `fs.promises` - Async file operations
- `child_process.exec` - Shell script execution
- `dotenv` - Environment variable loading

**Gotchas**:
- Raw body must be captured for signature verification (before JSON parsing)
- Stderr output doesn't always mean failure (scanner warnings are normal)
- Job timeout enforced but may be exceeded by a few seconds
- Queue doesn't deduplicate jobs (same commit can trigger multiple runs)

---

#### project-registry.json

**Purpose**: Central configuration database defining all monitored projects and their settings

**Structure**:
```json
{
  "projects": {
    "project-name": {
      "enabled": boolean,
      "repo_owner": "string",
      "repo_name": "string",
      "default_branch": "string",
      "workspace_path": "/absolute/path",
      "service_type": "pm2|docker|systemd|custom",
      "service_name": "string",
      "restart_command": "string",
      "docs_path": "docs",
      "codebase_map_file": "docs/CODEBASE_MAP.md"
    }
  },
  "settings": {
    "webhook_port": 6000,
    "max_concurrent_jobs": 2,
    "job_timeout_minutes": 30,
    "pr_branch_prefix": "docs/auto-update-",
    "pr_title_template": "ğŸ“š Auto-update documentation",
    "commit_message_template": "docs: auto-update documentation [skip ci]"
  }
}
```

**Managed Projects**:
1. **wish-x** - Main wish application
2. **wish-backend-x** - Backend API server
3. **as-you-wish-multi-agent** - Multi-agent orchestration system
4. **claude-agent-server** - Claude agent server

**Gotchas**:
- All paths must be absolute (no relative paths)
- `[skip ci]` in commit message prevents infinite webhook loops
- Service type determines restart strategy
- Changes require server restart to take effect

---

### Handler Scripts Module

#### handlers/generate-docs.sh

**Purpose**: Main orchestration script that executes the complete documentation generation workflow

**Workflow**:
1. Checkout main branch and pull latest changes
2. Create timestamped feature branch (`docs/auto-update-YYYYMMDD-HHMMSS`)
3. Invoke Cartographer via `utils/invoke-cartographer-programmatic.mjs`
4. Verify `docs/CODEBASE_MAP.md` was created
5. Stage and commit changes with metadata
6. Push branch to remote
7. Call `create-pr.sh` to create pull request
8. Return to main branch (cleanup)

**Environment Variables**:
```bash
PROJECT_NAME=<project-name>           # From webhook payload
WORKSPACE_PATH=/path/to/project       # From registry
COMMIT_SHA=<git-sha>                  # Source commit that triggered webhook
TRIGGER_EVENT=refs/heads/main         # Git ref from webhook
PR_BRANCH_PREFIX=docs/auto-update-    # From registry settings
```

**Exit Codes**:
- `0` - Success (documentation generated, PR created)
- `0` - No changes detected (not treated as error)
- `1` - Failure (Cartographer failed, no CODEBASE_MAP.md)

**Gotchas**:
- Returns exit code 0 even if no changes (cleans up branch gracefully)
- Always returns to main branch at end
- Branch deleted if no changes or on error
- Cartographer exit code doesn't indicate success (check file existence)

---

#### handlers/create-pr.sh

**Purpose**: Creates GitHub pull request using GitHub CLI (`gh`)

**Features**:
- Authenticates with `GITHUB_TOKEN` via stdin
- Creates PR with detailed body including:
  - Changes summary
  - Trigger event and commit SHA
  - Generation timestamp
  - Review checklist
- Adds labels: `documentation`, `automated`
- Auto-assigns to creator (`@me`)

**PR Body Template**:
```markdown
## ğŸ“š Documentation Update

This PR contains automatically generated documentation updates.

### Changes
- Updated `docs/CODEBASE_MAP.md` with latest codebase analysis

### Trigger Information
- **Event**: refs/heads/main
- **Commit**: abc123def456
- **Generated**: 2026-01-27T14:30:00Z

### Review Checklist
- [ ] Documentation is accurate and complete
- [ ] All sections are properly formatted
- [ ] Mermaid diagrams render correctly
- [ ] No sensitive information exposed
```

**Exit Codes**:
- `0` - PR created successfully
- `1` - gh CLI error (auth failed, network error, duplicate PR)

**Gotchas**:
- Must run from project workspace directory
- `gh` CLI must be installed and authenticated
- PR creation fails if branch already has open PR
- Token must have `repo` scope for PR creation

---

#### handlers/restart-service.sh

**Purpose**: Restarts application services after documentation PR merge

**Supported Service Types**:
| Type | Commands | Verification |
|------|----------|--------------|
| `pm2` | `pm2 restart <name>`, `pm2 save` | `pm2 list \| grep "online"` |
| `docker` | `docker restart <container>` | `docker ps \| grep <name>` |
| `systemd` | `sudo systemctl restart <unit>` | `systemctl is-active <unit>` |
| `custom` | `eval "$RESTART_COMMAND"` | None |

**Workflow**:
1. Pull latest changes from default branch
2. Restart service using appropriate method
3. Wait 2 seconds for startup
4. Verify service is running (except custom type)
5. Log success or error

**Gotchas**:
- Always pulls latest code before restart
- PM2: Falls back to starting service if not already running
- Docker: Requires container name, not image name
- systemd: Requires sudo permissions (configure in sudoers)
- Custom: No verification performed

---

### Cartographer Integration Module

#### utils/invoke-cartographer-programmatic.mjs âœ… PRIMARY

**Purpose**: Direct Claude API invocation that replicates Cartographer's workflow without CLI dependency

**Status**: âœ… **Production** - Primary and recommended approach

**Why This Approach**:
- **No interactive prompts** - Fully automated execution
- **Reliable** - Direct API control over entire process
- **Transparent** - Full visibility into API calls and responses
- **Debuggable** - Easy to log and trace issues

**Workflow**:
1. **Scan Codebase**:
   - Try Python scanner (`uv run scan-codebase.py`) first
   - Fallback to JavaScript file walker if Python unavailable
   - Output: File tree with token counts per file

2. **Group Files**:
   - Split files into groups under 120k tokens each
   - Keep related files together (same directory/module)
   - Balance token distribution across groups

3. **Analyze Groups** (Parallel):
   - Call Claude API for each group
   - Model: `claude-sonnet-4-20250514`
   - Max tokens: 4,096 per analysis
   - Prompt: Analyze purpose, exports, dependencies, patterns

4. **Synthesize Documentation**:
   - Call Claude API with all group analyses
   - Max tokens: 16,000 (final document)
   - Output: Complete `docs/CODEBASE_MAP.md` with:
     - System overview and architecture diagram
     - Directory structure with annotations
     - Module guide with detailed file descriptions
     - Data flow diagrams
     - Conventions and gotchas

5. **Write Output**:
   - Save to `docs/CODEBASE_MAP.md`
   - Include frontmatter with metadata

**Configuration**:
```javascript
const MODEL = 'claude-sonnet-4-20250514';
const MAX_TOKENS_PER_GROUP = 120000;
const MAX_TOKENS_OUTPUT = 16000;
const SCANNER_TIMEOUT = 30000;  // 30 seconds
```

**File Scanning**:

**Primary**: Python scanner (preferred)
```bash
uv run scan-codebase.py . --format json
```

**Fallback**: JavaScript walker
- Recursive directory traversal
- Ignores: `node_modules`, `.git`, `dist`, `build`, `.next`, `coverage`
- Includes: `.js`, `.ts`, `.jsx`, `.tsx`, `.json`, `.md`, `.py`, `.sh`, `.yaml`
- Token estimation: `file_size_bytes / 4`

**Exit Codes**:
- `0` - Documentation generated successfully
- `1` - API error, scanner failed, or no CODEBASE_MAP.md created

**Gotchas**:
- Scanner stderr is ignored (warnings common, not errors)
- API calls may fail if project exceeds 500k tokens
- Synthesis prompt is hardcoded (expects specific sections)
- Requires `ANTHROPIC_API_KEY` or `CLAUDE_API_KEY` in environment

---

#### utils/invoke-cartographer.mjs âŒ DEPRECATED

**Purpose**: Uses Claude Agent SDK's `query()` function to invoke Cartographer skill

**Status**: âŒ **Deprecated** - Replaced by programmatic approach

**Why Deprecated**:
- SDK still prompts for permissions despite auto-approval configuration
- Hangs waiting for interactive approval in automated environments
- `canUseTool` callback doesn't work as documented
- Not suitable for unattended execution

**Attempted Permission Bypass** (all failed):
```javascript
canUseTool: async () => ({ behavior: 'allow' })
permission_mode: 'bypassPermissions'
allowDangerouslySkipPermissions: true
```

**Workflow** (when it worked):
1. Create async generator with prompt: `"map this codebase"`
2. Call `query()` with auto-approval callback
3. Stream events: `text`, `tool_use`, `tool_result`, `error`
4. Write output to log file
5. Check if `docs/CODEBASE_MAP.md` was created

**Dependencies**:
- `@anthropic-ai/claude-agent-sdk` - Official SDK
- `uuid` - Session ID generation

---

#### utils/invoke-cartographer-direct.sh âš ï¸ SIMPLE

**Purpose**: Simple CLI passthrough that sends `/cartographer` command to claude CLI

**Status**: âš ï¸ **Unreliable** - Works for manual testing only

**Command**:
```bash
echo "/cartographer" | claude --cwd="$PROJECT_PATH"
```

**Issues**:
- Requires interactive terminal
- Prompts for permissions
- Output formatting inconsistent
- No error handling
- Not suitable for automation

---

#### utils/invoke-cartographer-v2.sh ğŸ§ª EXPERIMENTAL

**Purpose**: Experimental approach using `--print` mode

**Status**: ğŸ§ª **Experimental** - Not production-ready

**Command**:
```bash
claude --print --cwd="$PROJECT_PATH" "/cartographer"
```

**Issues**:
- Still requires interaction
- `--print` mode doesn't bypass permissions
- Undocumented behavior
- Not recommended for use

---

### Test Files Module

**Purpose**: Experiments testing different approaches to automating Cartographer invocation

| File | Strategy | Result |
|------|----------|--------|
| `test-sdk-minimal.mjs` | Minimal SDK test | âœ… Works (but prompts) |
| `test-cartographer-simple.mjs` | SDK with permission flags | âŒ Still prompts |
| `test-cartographer-verbose.mjs` | Verbose event logging | âŒ Still prompts |
| `test-cartographer-extraargs.mjs` | Extra CLI args for bypass | âŒ Still prompts |

**Key Findings**:
- SDK-based approaches all require interactive approval
- Permission bypass flags don't work as documented
- Direct API approach (programmatic) is the only reliable solution
- CLI `--print` mode also requires interaction

**Use Cases**:
- Testing new SDK features
- Debugging permission issues
- Prototyping alternative approaches
- NOT for production use

---

### Configuration Module

#### ecosystem.config.js

**Purpose**: PM2 process manager configuration

**Configuration**:
```javascript
{
  name: 'doc-automation-hub',           // PM2 process name
  script: 'server.js',                  // Entry point
  cwd: '/home/ubuntu/services/doc-automation-hub',
  instances: 1,                         // Single instance (not clustered)
  exec_mode: 'fork',                    // Fork mode (not cluster)
  autorestart: true,                    // Auto-restart on crash
  max_memory_restart: '500M',           // Restart if exceeds 500MB
  error_file: 'logs/error.log',
  out_file: 'logs/out.log',
  merge_logs: true,
  time: true,                           // Timestamp PM2 logs
  env: {
    NODE_ENV: 'production',
    PORT: 6000
  }
}
```

**PM2 Commands**:
```bash
pm2 start ecosystem.config.js          # Start service
pm2 restart doc-automation-hub         # Restart
pm2 logs doc-automation-hub            # View logs
pm2 status                             # Check status
pm2 save                               # Save process list
pm2 startup                            # Configure auto-start on boot
```

---

#### .env.example

**Purpose**: Environment variable template (secrets excluded)

**Required Variables**:
```bash
# GitHub Authentication
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GITHUB_WEBHOOK_SECRET=<generate-with-openssl-rand>

# Service Configuration
PORT=6000
NODE_ENV=production
LOG_LEVEL=info

# Webhook Security
WEBHOOK_SECRET=<same-as-github-webhook-secret>

# Claude Code CLI
CLAUDE_CODE_PATH=/usr/local/bin/claude

# Job Processing
MAX_CONCURRENT_JOBS=2
JOB_TIMEOUT_MINUTES=30

# Git Configuration
GIT_USER_NAME="Documentation Bot"
GIT_USER_EMAIL="docs-bot@automation.local"
```

**Security**:
- Never commit `.env` to git (included in `.gitignore`)
- Generate strong secrets: `openssl rand -hex 32`
- Use separate token for automation (not personal PAT)

---

### Documentation Module

#### README.md

**Purpose**: Comprehensive user documentation for setup, configuration, and usage

**Sections**:
1. Introduction and features
2. Architecture overview
3. Prerequisites and dependencies
4. Installation instructions
5. Configuration guide
6. Webhook setup (GitHub Actions)
7. Testing and verification
8. Troubleshooting
9. Maintenance and monitoring
10. Security best practices

**Target Audience**: DevOps engineers, developers setting up the hub

---

#### SETUP-COMPLETE.md

**Purpose**: Phase 1 setup checklist documenting initial deployment

**Contents**:
- Pre-deployment requirements verified
- Installation steps completed
- Configuration files created
- Nginx configuration applied
- PM2 setup and verification
- GitHub webhook configuration
- Test results and validation
- Next steps and enhancements

**Use Case**: Reference for what was done during initial setup

---

#### NGINX-CONFIG.md

**Purpose**: Nginx reverse proxy configuration documentation

**Contents**:
- Location block configuration
- Rate limiting setup
- Security headers
- Timeout settings
- SSL/TLS considerations (if applicable)
- Testing and verification commands

**Target Audience**: System administrators managing nginx

---

## Data Flow

### Documentation Generation (Happy Path)

```mermaid
sequenceDiagram
    participant GHA as GitHub Actions
    participant Nginx as Nginx Proxy
    participant Server as server.js
    participant Queue as Job Queue
    participant GenDocs as generate-docs.sh
    participant Cartographer as invoke-cartographer-<br/>programmatic.mjs
    participant ClaudeAPI as Claude API
    participant CreatePR as create-pr.sh
    participant GitHub as GitHub

    GHA->>Nginx: POST /doc-hub/webhook/generate-docs<br/>(HMAC-signed payload)
    Nginx->>Server: Proxy to localhost:6000
    Server->>Server: Verify HMAC signature
    Server->>Server: Load project-registry.json
    Server->>Queue: Add job to queue
    Server-->>GHA: 202 Accepted (job queued)

    Queue->>GenDocs: Execute when slot available
    GenDocs->>GenDocs: git checkout main && git pull
    GenDocs->>GenDocs: git checkout -b docs/auto-update-...
    GenDocs->>Cartographer: Invoke programmatically

    Cartographer->>Cartographer: Scan codebase (Python/JS)
    Cartographer->>Cartographer: Group files by token budget

    loop For each file group
        Cartographer->>ClaudeAPI: Analyze group
        ClaudeAPI-->>Cartographer: Analysis result
    end

    Cartographer->>ClaudeAPI: Synthesize final docs
    ClaudeAPI-->>Cartographer: docs/CODEBASE_MAP.md
    Cartographer-->>GenDocs: Documentation generated

    GenDocs->>GenDocs: git add docs/ && git commit
    GenDocs->>GenDocs: git push -u origin branch
    GenDocs->>CreatePR: Execute create-pr.sh

    CreatePR->>GitHub: gh pr create (API call)
    GitHub-->>CreatePR: PR URL
    CreatePR-->>GenDocs: Success
    GenDocs-->>Queue: Job complete
    Queue->>Server: Log results
```

### Service Restart After PR Merge

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant GitHub as GitHub
    participant GHA as GitHub Actions
    participant Server as server.js
    participant Restart as restart-service.sh
    participant PM2 as PM2 Process

    Dev->>GitHub: Merge PR
    GitHub->>GHA: Trigger workflow (on merge)
    GHA->>Server: POST /webhook/restart-service
    Server->>Server: Verify HMAC & check merge event
    Server->>Restart: Execute restart-service.sh
    Restart->>Restart: git pull origin main
    Restart->>PM2: pm2 restart <service-name>
    PM2-->>Restart: Service restarted
    Restart->>Restart: Verify service online
    Restart-->>Server: Success
    Server-->>GHA: 200 OK
```

## Conventions

### 1. Logging

**Format**: Structured JSON with timestamp, level, message, and metadata

**Example**:
```json
{
  "timestamp": "2026-01-27T14:40:00.000Z",
  "level": "info",
  "message": "Documentation job queued",
  "project": "wish-x",
  "queuePosition": 1,
  "activeJobs": 0
}
```

**Levels**: `info` (normal), `warn` (non-fatal), `error` (fatal)

**Files**: Daily rotation `logs/hub-YYYY-MM-DD.log`

---

### 2. Git Branch Naming

**Pattern**: `docs/auto-update-YYYYMMDD-HHMMSS`

**Examples**:
- `docs/auto-update-20260127-143000`
- `docs/auto-update-20260128-091530`

**Benefits**: Unique per invocation, chronologically sortable, easily identifiable

---

### 3. Commit Messages

**Format**:
```
docs: auto-update documentation [skip ci]

Generated by Documentation Automation Hub
Triggered by: refs/heads/main
Source commit: abc123def456
```

**Key Elements**:
- Conventional commits prefix: `docs:`
- `[skip ci]` prevents infinite webhook loops
- Metadata for traceability

---

### 4. Error Handling

**Philosophy**: Fail gracefully, log extensively, return meaningful errors

**Patterns**:
- Webhook signature failures â†’ 401 Unauthorized
- Missing projects â†’ 404 Not Found
- Queue errors â†’ 500 Internal Server Error
- Script errors â†’ Log and continue queue (don't crash server)

---

### 5. Environment Variables

**Priority** (highest to lowest):
1. Script arguments (positional parameters)
2. Environment variables passed to script
3. `.env` file values
4. Hardcoded defaults in scripts

---

## Gotchas

### 1. HMAC Signature Requires Raw Body âš ï¸

**Problem**: Express's `express.json()` parses body before signature verification

**Solution**: Capture raw body in middleware's `verify` callback:
```javascript
app.use(express.json({
  verify: (req, res, buf, encoding) => {
    if (req.path.startsWith('/webhook/')) {
      req.rawBody = buf.toString('utf8');
    }
  }
}));
```

**Impact**: Using `req.body` for signature produces different HMAC than GitHub

---

### 2. Cartographer Exit Code Doesn't Indicate Success âš ï¸

**Problem**: Cartographer may exit 0 but fail to create `docs/CODEBASE_MAP.md`

**Solution**: Always check file existence, not exit code

**Stderr**: Scanner warnings are normal (not errors)

---

### 3. Claude SDK Permission Bypass Doesn't Work âŒ

**Problem**: `canUseTool` callback and permission flags don't prevent prompts

**Solution**: Use direct Claude API invocation (programmatic approach)

**Status**: SDK approach deprecated

---

### 4. Job Queue Doesn't Deduplicate âš ï¸

**Problem**: Multiple webhooks for same project queue multiple jobs

**Impact**: Wasted API calls if same commit triggers multiple webhooks

**Mitigation**: None implemented (future enhancement)

---

### 5. PM2 Restart Doesn't Auto-Reload Environment âš ï¸

**Problem**: Editing `.env` doesn't affect running process

**Solution**: Always restart after environment changes:
```bash
nano .env && pm2 restart doc-automation-hub
```

---

### 6. Rate Limiting Affects Health Checks âš ï¸

**Problem**: Nginx rate limit (10 req/min) affects all endpoints including `/health`

**Impact**: Monitoring systems may be throttled

**Solution**: Exclude `/health` from rate limiting (future enhancement)

---

### 7. Large Codebases May Exceed Capacity âš ï¸

**Problem**: Projects >500k tokens may exceed single-run capacity

**Behavior**: First N file groups analyzed, rest skipped silently

**Detection**: Check logs for "truncated" or "exceeded token limit" warnings

**Mitigation**: None implemented (future: multi-pass analysis)

---

### 8. Webhook Signature Mismatch Debugging ğŸ”

**Common Causes**:
- Different secrets in `.env` vs GitHub Actions
- Payload formatting differences
- Character encoding issues

**Debug**: Log received signature, computed digest, payload length

---

## Navigation Guide

### To Add a New Project

1. **Update Registry**:
   ```bash
   nano project-registry.json
   ```
   Add project configuration under `"projects"`

2. **Configure GitHub Webhook**:
   - Repository Settings â†’ Webhooks â†’ Add webhook
   - URL: `https://y1.andiami.tech/doc-hub/webhook/generate-docs`
   - Secret: Copy from `.env` (`WEBHOOK_SECRET`)
   - Events: Push events only

3. **Test Webhook**:
   ```bash
   curl -X POST http://y1.andiami.tech/doc-hub/health | jq .
   ```
   Push to repository and check logs

4. **Restart Server**:
   ```bash
   pm2 restart doc-automation-hub
   ```

---

### To Modify Documentation Generation Logic

**File**: `handlers/generate-docs.sh`

**Common Changes**:
- Branch naming: Edit `PR_BRANCH_PREFIX`
- Commit message: Edit `COMMIT_MSG_TEMPLATE`
- PR title/body: Edit `create-pr.sh`

**After Changes**: No restart needed (handlers executed per-job)

---

### To Debug Webhook Issues

1. **Check Server Logs**:
   ```bash
   tail -f logs/hub-$(date +%Y-%m-%d).log | jq .
   ```

2. **Check PM2 Logs**:
   ```bash
   pm2 logs doc-automation-hub --lines 50
   ```

3. **Check Nginx Logs**:
   ```bash
   tail -f /var/log/nginx/access.log | grep doc-hub
   ```

4. **Verify Signature**:
   - Log incoming signature and computed digest
   - Use `openssl` to manually verify HMAC

---

### To Modify Cartographer Invocation

**File**: `utils/invoke-cartographer-programmatic.mjs`

**Common Changes**:
- Token budget per group: `MAX_TOKENS_PER_GROUP`
- Output token limit: `MAX_TOKENS_OUTPUT`
- Model: `MODEL` constant
- Scanner timeout: `SCANNER_TIMEOUT`

**After Changes**: No restart needed (invoked per-job)

---

### To Change Service Restart Behavior

**File**: `handlers/restart-service.sh`

**Common Changes**:
- Add new service type (e.g., Kubernetes)
- Modify verification commands
- Add pre/post-restart hooks

**After Changes**: No restart needed

---

### To Adjust Rate Limits

**File**: `/etc/nginx/sites-available/y1.andiami.tech`

**Change**:
```nginx
limit_req zone=doc_hub_zone burst=5 nodelay;
```

**Reload**:
```bash
sudo nginx -t && sudo nginx -s reload
```

---

### To Monitor Queue Health

**Endpoint**: `GET /health`

**Response**:
```json
{
  "status": "ok",
  "activeJobs": 0,
  "queueLength": 0,
  "uptime": 384.47
}
```

**Alerting**: Set up monitoring for `queueLength > 5` or `activeJobs === MAX_CONCURRENT_JOBS` for extended periods

---

## Deployment Reference

**Platform**: AWS EC2 (Ubuntu Linux)

**Ports**:
- Internal: `6000` (webhook listener, localhost only)
- External: `80` (nginx, proxies to 6000)

**Base Path**: `/doc-hub/`

**Process Manager**: PM2
- Name: `doc-automation-hub`
- Auto-restart: Enabled
- Auto-start on boot: Enabled via systemd

**Nginx Config**: `/etc/nginx/sites-available/y1.andiami.tech`

**Log Retention**: Manual cleanup (7 days recommended)

**Dependencies**:
- Node.js 18+ (LTS)
- npm 9+
- GitHub CLI (`gh`)
- Git 2.30+
- Python 3.9+ (optional, for scanner)
- tiktoken (Python package, optional)

---

## Summary

The Documentation Automation Hub is a production-ready, multi-project documentation automation service with:

âœ… **Secure webhooks** - HMAC-SHA256 signature validation
âœ… **Reliable execution** - Direct Claude API (not SDK, no prompts)
âœ… **PR-based workflow** - All changes reviewed before merge
âœ… **Queue management** - Handles concurrent jobs with timeouts
âœ… **Comprehensive logging** - Structured JSON, daily rotation
âœ… **Multi-project support** - Single hub for 4+ projects
âœ… **Auto-restart** - PM2 ensures service availability
âœ… **Nginx integration** - Rate limiting, security headers

**Key Technical Decisions**:
- Direct Claude API over SDK (avoids permission prompts)
- Bash scripts for orchestration (simple, maintainable)
- PM2 for process management (production-grade)
- JSON logging (machine-readable, parseable)
- PR-based workflow (no direct commits to main)

**Next Steps for Enhancement**:
- [ ] Job deduplication by commit SHA
- [ ] Webhook retry on failure with exponential backoff
- [ ] Dashboard for monitoring queue and logs
- [ ] Email/Slack notifications on job failure
- [ ] Multi-pass analysis for large codebases (>500k tokens)
- [ ] Health check exclusion from rate limiting
- [ ] Automatic log cleanup (7-day retention)

---

**For detailed architecture documentation, see**: [README.md](../README.md)

**For setup instructions, see**: [SETUP-COMPLETE.md](../SETUP-COMPLETE.md)

**For nginx configuration, see**: [NGINX-CONFIG.md](../NGINX-CONFIG.md)

---

If cartographer helped you, consider starring: https://github.com/kingbootoshi/cartographer - please!
